# Red compartida para que los servicios se vean por nombre
networks:
  arbitrage-net:
    driver: bridge

# Volumen para persistencia de datos de Redis
volumes:
  redis_data:
    driver: local

services:
  # 1. Redis: Broker de mensajes
  redis:
    image: redis:7-alpine
    container_name: arbitrage-redis
    networks:
      - arbitrage-net
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # 2. Quant Engine: Cerebro (Python)
  # Recibe datos por ZMQ (puerto 5556) y publica en Redis
  quant-engine:
    build: ./quant-engine
    container_name: arbitrage-quant-engine
    networks:
      - arbitrage-net
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis
      # Escucha en todas las interfaces internas del contenedor
      - ZMQ_ADDRESS=tcp://0.0.0.0:5556
    depends_on:
      - redis
    restart: unless-stopped

  # 3. Ingestor: Recolector de datos (Node.js)
  # Se conecta a los exchanges y env√≠a datos al Quant Engine
  ingestor:
    build: ./ingestor
    container_name: arbitrage-ingestor
    networks:
      - arbitrage-net
    environment:
      - NODE_ENV=production
      # Se conecta al servicio quant-engine
      - ZMQ_ADDRESS=tcp://quant-engine:5556
    depends_on:
      - quant-engine
    restart: unless-stopped

  # 4. Frontend Bridge: WebSocket Server (Python)
  # Puente entre Redis y el navegador
  frontend-bridge:
    build: ./frontend-bridge
    container_name: arbitrage-frontend-bridge
    networks:
      - arbitrage-net
    ports:
      - "8765:8765" # Expone WebSocket al host
    environment:
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis
    restart: unless-stopped

  # 5. Frontend: Dashboard Web (React/Node)
  frontend:
    build: ./frontend
    container_name: arbitrage-frontend
    networks:
      - arbitrage-net
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
    restart: unless-stopped
